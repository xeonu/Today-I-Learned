# Scale out 세션 불일치 문제
## Scale out
서버를 확장하기 위한 방법 중 하나이다. 서버 자체의 사양을 증가시키는 것이 아니라 비슷한 성능의 여러 서버를 증설하여 성능 향상을 이루고자한다. 서버 사양을 고사양으로 변경하는 Scale up과 대비되는 개념이다. 

Scale out은 Scale up에 비해 비용대비 성능 향상폭이 크고 지속적으로 확장 가능하다. 그리고 장애 발생 시 Scale up에 비해 대처하기 수월하다. 다만 구현하기 어렵고 세션 불일치와 같은 문제를 해결해야한다.  

## 세션 불일치 문제
다중서버 환경으로 서버환경을 구성하면 세션 불일치 문제가 발생한다. 클라이언트가 서버로부터 어떤 작업을 요청하면 로드밸런서는 적절한 서버로 요청정보를 전달한다. 이 때 각각의 서버마다 세션정보를 다르게 가지고 있으면 새로운 서버에 요청을 보낼 때 마다 세션을 생성해야하는 번거로움이 있다. 

#  세션 불일치 문제 해결방법
## Sticky Session
로드밸런서가 클라이언트 요청을 항상 동일한 서버로 전달하는 방식이다. 만약 모든 서버에 클라이언트에 대한 세션 정보가 없다면 로드 밸런서 알고리즘에 의해 적절한 서버에 배치한다. 매칭 된 서버 정보는 쿠키를 통해 파악한다.

### 장점
- 원리 자체가 단순하여 구현하기 쉽다.
- 확실하게 세션 불일치 문제를 해결할 수 있다.

### 단점
- 특정 서버에 트래픽이 집중될 수 있다.
- 특정 서버에 장애가 발생하면 해당 서버와 연결되어있던 클라이언트들의 세션 정보가 모두 사라질 수 있다.

## Session Clustering
각 서버의 세션 저장소를 하나의 클러스터로 묶고 클러스터 내부의 저장소들이 세션을 공유할 수 있게 한다. All-to-All Session Replication과 Primary-Secondary Session Replication에 대해 알아보자.

## All-to-All Session Replication
모든 서버들이 서로의 세션 저장소 내용을 복제하여 어떤 서버로 방문해도 세션 정보가 존재하게 하는 방식이다. 

### 장점
- 특정 서버에 장애가 발생하더라도 세션 정보를 유지할 수 있다.
- 세션 정보가 클라이언트의 요청을 받은 서버에 있다는 것이 확실하므로 추가적으로 세션을 다른 서버에서 찾기 위한 네트워크 I/O가 발생하지 않는다.

### 단점
- 세션을 저장하기 위해 메모리 공간을 많이 사용한다.
- 세션 정보를 복사하기 위한 네트워크 I/O가 많이 발생한다. 서버 개수가 너무 많을 경우 치명적이므로 서버 개수가 4개 미만 일 때 사용하기 적절하다.
- 서버끼리 세션 정보를 복사하는 과정에서의 시차로 인해 세션 불일치 문제가 발생할 수 있다.

## Primary-Secondary Session Replication
Primary 서버와 Secondary 서버에만 전체 세션정보를 저장하고 나머지 서버에는 JSESSIONID만 복제하여 저장한다.

### 장점
- All-to-All Session Replication에 비해 세션 저장을 위한 메모리 공간을 절약할 수 있다.

### 단점
- 서버 세팅 과정이 어렵다. 
- 여전히 세션 저장을 위한 중복된 세션의 추가적인 메모리 공간이 발생한다.
- 세션 정보를 다른 서버의 세션저장소로 복제하기 위한 네트워크 I/O가 발생한다.
- 서버끼리 세션 정보를 복사하는 과정에서의 시차로 인해 세션 불일치 문제가 발생할 수 있다.

## Session Stroage
각 서버마다 세션저장소를 생성하지 말고 외부의 세션 저장소를 생성하고 서버들이 참조하는 방식이다.

### 장점
- 중복된 세션 정보를 저장할 필요가 없어 메모리 공간을 절약할 수 있다.
- 세션 정보를 서버끼리 공유하기 위한 네트워크 I/O가 발생하지 않는다.
- 서버의 장애로 부터 세션정보를 보호할 수 있다.

### 단점
- 세션 정보를 가져오기 위해서 네트워크 I/O가 발생한다.
- 세션 저장소에 장애가 발생하면 모든 서버는 세션정보를 제공받을 수 없다. 